groups:
  - name: http_aggregation
    rules:
      # QPS (per application)
      - record: job:http_requests_per_second:rate5m
        expr: sum by (application) (rate(http_server_requests_seconds_count[5m]))

      # Error rate per second (non-2xx)
      - record: job:http_errors_per_second:rate5m
        expr: sum by (application) (rate(http_server_requests_seconds_count{status!~"2.."}[5m]))

      # Error % = errors / total * 100
      - record: job:http_error_ratio:percent5m
        expr: 100 * job:http_errors_per_second:rate5m / job:http_requests_per_second:rate5m

      # p95 latency (Micrometer exposes buckets)
      - record: job:http_request_duration_seconds:p95
        expr: |
          histogram_quantile(
            0.95,
            sum by (le, application) (
              rate(http_server_requests_seconds_bucket[5m])
            )
          )

      # JVM heap used %
      - record: job:jvm_heap_used_percent
        expr: |
          100 * sum by (application) (jvm_memory_used_bytes{area="heap"})
              /
              sum by (application) (jvm_memory_max_bytes{area="heap"})
